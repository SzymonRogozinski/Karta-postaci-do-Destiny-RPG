<!--Postać po krótce-->
<div id="General_description">
    Imię: <input type="text" name="attr_name"><br>

    Płeć:<select name="attr_gender">
            <option value="-">-</option>
            <option value="K">K</option>
            <option value="M">M</option>
        </select><br>

    Rasa:<select name="attr_race">
            <option value="-">-</option>
            <option value="Człowiek">Człowiek</option>
            <option value="Exo">Exo</option>
            <option value="Przebudzony">Przebudzony</option>
        </select><br>

    Klasa:<select name="attr_class">
            <option value="-">-</option>
            <option value="Tytan">Tytan</option>
            <option value="Łowca">Łowca</option>
            <option value="Czarownik">Czarownik</option>
        </select><br>

    Podklasa:<select id="subclass_list" name="attr_subclass">
                <option value="-">-</option>
                <option value="Słoneczny pogromca">Słoneczny pogromca</option>
                <option value="Szturmowiec">Szturmowiec</option>
                <option value="Wartownik">Wartownik</option>
                <option value="Strzelec">Strzelec</option>
                <option value="Gromodzierżca">Gromodzierżca</option>
                <option value="Tropiciel">Tropiciel</option>
                <option value="Ostrze świtu">Ostrze świtu</option>
                <option value="Kroczący przez próżnię">Kroczący przez próżnię</option>
                <option value="Siewca burz">Siewca burz</option>
        </select><br>

    Ranga:<input type="text" name="attr_rank" value="-" readonly><br>

    Poziom:<input type="text" name="attr_level" value="0" readonly><br>

    PD:<input type="text" name="attr_EXP_To_Next_Level" value="0" readonly><br>
</div>

<!--Cechy postaci-->
<div id="Atributes">
    <h3>Cechy</h3>

    Siła<select name="attr_strength" value="d4">
        <option value="d4">k4</option>
        <option value="d6">k6</option>
        <option value="d8">k8</option>
        <option value="d10">k10</option>
        <option value="d12">k12</option>
    </select>
    <input type="hidden" name="attr_strength_mod" value="0">
    <button type="action" name="act_roll_strength"></button><br>

    Zręczność<select name="attr_agility" value="d4">
        <option value="d4">k4</option>
        <option value="d6">k6</option>
        <option value="d8">k8</option>
        <option value="d10">k10</option>
        <option value="d12">k12</option>
    </select>
    <input type="hidden" name="attr_agility_mod" value="0">
    <button type="action" name="act_roll_agility"></button><br>

    Spryt<select name="attr_smart" value="d4">
        <option value="d4">k4</option>
        <option value="d6">k6</option>
        <option value="d8">k8</option>
        <option value="d10">k10</option>
        <option value="d12">k12</option>
    </select>
    <input type="hidden" name="attr_smart_mod" value="0">
    <button type="action" name="act_roll_smart"></button><br>

    Duch<select name="attr_spirit" value="d4">
        <option value="d4">k4</option>
        <option value="d6">k6</option>
        <option value="d8">k8</option>
        <option value="d10">k10</option>
        <option value="d12">k12</option>
    </select>
    <input type="hidden" name="attr_spirit_mod" value="0">
    <button type="action" name="act_roll_spirit"></button><br>

    Wigor<select name="attr_vigor" value="d4">
        <option value="d4">k4</option>
        <option value="d6">k6</option>
        <option value="d8">k8</option>
        <option value="d10">k10</option>
        <option value="d12">k12</option>
    </select>
    <input type="hidden" name="attr_vigor_mod" value="0">
    <button type="action" name="act_roll_vigor"></button><br>

    Obrona:<input type="text" name="attr_parry" value="2" readonly><br>
    <input type="hidden" name="attr_parry_mod" value="0">

    Wytrzymałość:<input type="text" name="attr_tough" value="2" readonly><br>
    <input type="hidden" name="attr_tough_mod" value="0">

    Charyzma:<input type="text" name="attr_charisma" value="0" readonly><br>

    Tempo:<input type="text" name="attr_speed" value="6" readonly><br>

    Fuksy:<input type="number" name="attr_luck" value="3"><br>
    <input type="hidden" name="attr_luck_max" value="3">
    

    Rozmiar:<input type="text" name="attr_size" value="0" readonly><br>
</div>

<div id="Skills">
    <h3>Umiejętności</h3>

    Hazard [Spryt]<select name="attr_gamble" value="-">
        <option value="-">-</option>
        <option value="d4">k4</option>
        <option value="d6">k6</option>
        <option value="d8">k8</option>
        <option value="d10">k10</option>
        <option value="d12">k12</option>
    </select>
    <input type="hidden" name="attr_gamble_mod" value="0">
    <button type="action" name="act_roll_gamble"></button><br>

<!--
Hazard [Spryt]
Pilotowanie [Zręczność]
Prowadzenie [Zręczność]
 Przekonywanie [Duch]
 Przetrwanie [Spryt]
 Reperowanie [Spryt]
 Ruch [Zręczność]
 Rzucanie [Zręczność]
 Skradanie się [Zręczność]
 Spostrzegawczość [Spryt]
 Strzelanie [Zręczność]
 Tropienie [Spryt]
 Walka wręcz [Zręczność]
 Wyszukiwanie [Spryt]
 Wyśmiewanie [Spryt]
 Włamywanie się [Zręczność]
 Zastraszanie [Duch]
-->

</div>

<input type="number" name="attr_EXP">

<rolltemplate class="sheet-rolltemplate-BasicDiceRoll">
    <div class="sheet-template-container">
        <h1>{{name}}</h1>
        <div class="sheet-results">
            <h4>Kość główna = {{wynik}}</h4>
            <h4>Kość figury = {{pomoc}}</h4>
            {{#rollGreater() computed::wynik 3}}
                <h4>Test zdany</h4>
            {{/rollGreater() computed::wynik 3}}
            {{#rollLess() computed::wynik 4}}
                <h4>Test niezdany</h4>
            {{/rollLess() computed::wynik 4}}
        </div>
    </div>
</rolltemplate>


<script type="text/worker">
    //Walidacja podklasy
    on("change:subclass", function(){
        getAttrs(["class","subclass"], function(values){
            var cl=values.class;    
            var sc=values.subclass;
            if(cl == "Tytan"){
                if(sc!="Słoneczny pogromca" && sc!="Szturmowiec" && sc!="Wartownik"){
                    setAttrs({subclass: "-"});
                }
            }else if(cl =="Łowca"){
                if(sc!="Strzelec" && sc!="Gromodzierżca" && sc!="Tropiciel"){
                    setAttrs({subclass: "-"});
                }
            }else if(cl == "Czarownik"){
                if(sc!="Ostrze świtu" && sc!="Kroczący przez próżnię" && sc!="Siewca burz"){
                    setAttrs({subclass: "-"});
                }
            }
        })
    })

    //Zmiana liczby doświadczenia
    on("change:EXP", function(){
        getAttrs(["EXP","level"], function(values){
            var e=values.EXP;
            //Pierw ile expa brakuje, dalej jaki level
            setAttrs({
                EXP_To_Next_Level:e%5,
                level: parseInt(e/5)
            });
            var l=values.level;
            if(l<9){
                setAttrs({rank: "Nowicjusz"});
            }else if(l<17){
                setAttrs({rank: "Doświadczony"});
            }else if(l<25){
                setAttrs({rank: "Weteran"});
            }else if(l<33){
                setAttrs({rank: "Heros"});
            }else{
                setAttrs({rank: "Legenda"});
            }
        })
    })

    //Usuwa przedrostek z nazwy kości
    function dice_max_value(dice){
        var v=dice.slice(1)
        return v!=""?v:0
    }

    //Sprawdzanie czy rasa Przebudzonych ma odpowiednią wartość ducha
    on("change:spirit change:race",function(){
        getAttrs(["spirit","race"],function(values){
            var r=values.race
            var s=values.spirit
        
            if(r=="Przebudzony" && s=="d4"){
                setAttrs({spirit: "d6"})
            }
        })
    })

    //Sprawdzanie czy aktualna wartość fuksów nie jest za duża
    on("change:luck",function(){
        getAttrs(["luck_max","luck"],function(values){
            var lm=values.luck_max
            var l=values.luck
            if(l<0){
                setAttrs({luck: 0}) 
            }else if(l>lm){
                setAttrs({luck: lm}) 
            }
        })
    })

    //Obliczanie wytrzymałości
    on("change:vigor change:tough_mod", function(){
        getAttrs(["vigor","tough_mod","size"], function(values){
            var v=parseInt(dice_max_value(values.vigor))    //Parsowanie
            var tm=parseInt(values.tough_mod)
            var s=parseInt(values.size)

            v=v/2+tm+s+2                                    //Dodanie modyfikatorów
            setAttrs({tough: v})                            //ustawienie wytrzymałości
        })
    })

    //Obliczanie obrony
    on("change:brawl change:parry_mod", function(){
        getAttrs(["brawl","parry_mod"], function(values){
            var p=parseInt(dice_max_value(values.brawl))    //Parsowanie
            var pm=parseInt(values.parry_mod)

            p=p/2+pm+2                                      //Dodanie modyfikatorów
            setAttrs({parry: p})                            //ustawienie wytrzymałości
        })
    })

    //Funkcja służąca do podpinania rzutu do przycisku
    function bind_roll(attribute_name,attribute){
        var query="&{template:BasicDiceRoll} "                                                          //Szablon rzutu
        query=query.concat("{{name=@{name} wykonuje test "+attribute_name+"}} ")                        //Nazwa rzutu
        var atr

        getAttrs([attribute], function(values){
            atr=values[attribute]
        })
        
        //Sprawdzenie czy umiejętność jest wykupiona
        if(atr!="-"){
            query=query.concat("{{wynik=[[@{"+attribute+"}! +@{"+attribute+"_mod} +?{Modyfikator|0}]]}} ")    //Rzut kością główną
            query=query.concat("{{pomoc=[[d6! +@{"+attribute+"_mod} +?{Modyfikator|0}]]}}")                   //Rzut kością figury
        }else{
            query=query.concat("{{wynik=[[d4!]]}} ")    //Rzut kością główną
            query=query.concat("{{pomoc=[[d6!]]}}")                   //Rzut kością figury
        }

        startRoll(query, (results) => {
            var basicDice = results.results.wynik.result    //Kość główna
            var figDice = results.results.pomoc.result      //Kość figury
            var resDice                                     //Kość wyniku

            //Jeśli kość główna nie jest równa jeden i figury jest większa, to zamień
            if(basicDice!=1 && figDice>basicDice){
                resDice=figDice
            }else{
                resDice=basicDice
            }
            finishRoll(
                results.rollId,
                {
                    wynik: resDice
                }
            )

        })
    }

    //Przypisanie rzutów do cech
    on('clicked:roll_strength', (info) => {
        bind_roll("siły","strength")
    })

    on('clicked:roll_agility', (info) => {
        bind_roll("zręczności","agility")
    })

    on('clicked:roll_smart', (info) => {
        bind_roll("sprytu","smart")
    })

    on('clicked:roll_spirit', (info) => {
        bind_roll("ducha","spirit")
    })

    on('clicked:roll_vigor', (info) => {
        bind_roll("wigoru","vigor")
    })

    //Przypisanie rzutów do umiejętności
    on('clicked:roll_gamble', (info) => {
        bind_roll("hazardu","gamble")
    })


</script>