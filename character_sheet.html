<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab"  value="main"  />
<div class="sheet_selector">
    <button type="action" name="act_main" >Główna strona</button>
    <button type="action" name="act_equipment" >Ekwipunek</button>
    <button type="action" name="act_details" >Szczegóły</button>
</div>

<div class='sheet-main'>
    <!--Pierwsza kolumna--><div class="sheet-col">
        <!--Postać po krótce-->
        <div id="General_description" class="sector">
            <div class="sub_sector">
                Imię: <input class="input_long" type="text" name="attr_name">

                Płeć:<select class="short_select" name="attr_gender">
                    <option value="-">-</option>
                    <option value="K">K</option>
                    <option value="M">M</option>
                </select>
            </div>

            <div class="sub_sector">
                Rasa:<select class="text_select" name="attr_race">
                    <option value="-">-</option>
                    <option value="Człowiek">Człowiek</option>
                    <option value="Exo">Exo</option>
                    <option value="Przebudzony">Przebudzony</option>
                </select><br>
            </div>

            <div class="sub_sector">
                Klasa:<select class="text_select" name="attr_class">
                    <option value="-">-</option>
                    <option value="Tytan">Tytan</option>
                    <option value="Łowca">Łowca</option>
                    <option value="Czarownik">Czarownik</option>
                </select><br>
            </div>

            <div class="sub_sector">
                Podklasa:<select class="text_select" id="subclass_list" name="attr_subclass">
                    <option value="-">-</option>
                    <option value="Słoneczny pogromca">Słoneczny pogromca</option>
                    <option value="Szturmowiec">Szturmowiec</option>
                    <option value="Wartownik">Wartownik</option>
                    <option value="Strzelec">Strzelec</option>
                    <option value="Gromodzierżca">Gromodzierżca</option>
                    <option value="Tropiciel">Tropiciel</option>
                    <option value="Ostrze świtu">Ostrze świtu</option>
                    <option value="Kroczący przez próżnię">Kroczący przez próżnię</option>
                    <option value="Siewca burz">Siewca burz</option>
                </select><br>
            </div>

            <div class="sub_sector">
                Ranga:<input class="input_long" type="text" name="attr_rank" value="-" readonly><br>
            </div>

            <div class="sub_sector">
                Poziom:<input class="input_short" type="text" name="attr_level" value="0" readonly><br>

                PD:<input class="input_short" type="text" name="attr_EXP_To_Next_Level" value="0" readonly><br>
            </div>
        </div>

        <div id="Skills" class="sector">
            <h3>Umiejętności</h3>

            <h6>Spryt</h6>
            <div class="sub_sector">
                Hazard [Spryt]<select class="short_select" name="attr_gamble" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_gamble_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_gamble"></button><br>
            </div>
            <div class="sub_sector">
                Przetrwanie [Spryt]<select class="short_select" name="attr_survival" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_survival_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_survival"></button><br>
            </div>
            <div class="sub_sector">
                Reperowanie [Spryt]<select class="short_select" name="attr_repair" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_repair_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_repair"></button><br>
            </div>
            <div class="sub_sector">
                Spostrzegawczość [Spryt]<select class="short_select" name="attr_spot" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_spot_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_spot"></button><br>
            </div>
            <div class="sub_sector">
                Tropienie [Spryt]<select class="short_select" name="attr_tracking" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_tracking_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_tracking"></button><br>
            </div>
            <div class="sub_sector">
                Wyszukiwanie [Spryt]<select class="short_select" name="attr_search" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_search_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_search"></button><br>
            </div>
            <div class="sub_sector">
                Wyśmiewanie [Spryt]<select class="short_select" name="attr_ridicule" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_ridicule_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_ridicule"></button><br>
            </div>
            <h6>Zręczność</h6>
            <div class="sub_sector">
                Pilotowanie [Zręczność]<select class="short_select" name="attr_pilotage" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_pilotage_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_pilotage"></button><br>
            </div>
            <div class="sub_sector">
                Prowadzenie [Zręczność]<select class="short_select" name="attr_drive" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_drive_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_drive"></button><br>
            </div>
            <div class="sub_sector">
                Ruch [Zręczność]<select class="short_select" name="attr_move" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_move_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_move"></button><br>
            </div>
            <div class="sub_sector">
                Rzucanie [Zręczność]<select class="short_select" name="attr_throw" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_throw_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_throw"></button><br>
            </div>
            <div class="sub_sector">
                Skradanie się [Zręczność]<select class="short_select" name="attr_stealth" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_stealth_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_stealth"></button><br>
            </div>
            <div class="sub_sector">
                Strzelanie [Zręczność]<select class="short_select" name="attr_shoot" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_shoot_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_shoot"></button><br>
            </div>
            <div class="sub_sector">
                Walka wręcz [Zręczność]<select class="short_select" name="attr_brawl" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_brawl_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_brawl"></button><br>
            </div>
            <div class="sub_sector">
                Włamywanie się [Zręczność]<select class="short_select" name="attr_breaking" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_breaking_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_breaking"></button><br>
            </div>
            <h6>Duch</h6>
            <div class="sub_sector">
                Przekonywanie [Duch]<select class="short_select" name="attr_persuade" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_persuade_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_persuade"></button><br>
            </div>
            <div class="sub_sector">
                Zastraszanie [Duch]<select class="short_select" name="attr_intimidate" value="-">
                    <option value="-">-</option>
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_intimidate_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_intimidate"></button><br>
            </div>

            <h6>Dodatkowe</h6>
            <div class="sub_sector">
                <div>
                    <fieldset class="repeating_newskill">
                        <input class="input_long" type="text" name="attr_nsname">
                        <select class="short_select" name="attr_nsvalue" value="-">
                            <option value="-">-</option>
                            <option value="d4">k4</option>
                            <option value="d6">k6</option>
                            <option value="d8">k8</option>
                            <option value="d10">k10</option>
                            <option value="d12">k12</option>
                        </select>
                        <input type="hidden" name="attr_nsvaluemod" value="0">
                        <button type="action" class="roll_button" name="act_rollns"></button>
                    </fieldset>
                </div>
            </div>
        </div>
    </div><!--Druga kolumna--><div class="sheet-col">
        <!--Cechy postaci-->
        <div id="Atributes" class="sector">
            <h3>Cechy</h3>
            <div class="sub_sector">
                Siła<select class="short_select" name="attr_strength" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_strength_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_strength"></button><br>

                Zręczność<select class="short_select" name="attr_agility" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_agility_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_agility"></button><br>
            </div>
            <div class="sub_sector">
                Spryt<select class="short_select" name="attr_smart" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_smart_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_smart"></button><br>

                Duch<select class="short_select" name="attr_spirit" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_spirit_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_spirit"></button><br>
            </div>
            <div class="vig_sub_sector">
                Wigor<select class="vig_select" name="attr_vigor" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" class="roll_button" name="attr_vigor_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_vigor"></button><br>
            </div>
            <!--Cechy pochodne-->
            <div class="sub_sector">
                Obrona:<input class="input_short" type="text" name="attr_parry" value="2" readonly><br>
                <input type="hidden" name="attr_parry_mod" value="0">

                Wytrzymałość:<input class="input_short" type="text" name="attr_tough" value="2" readonly><br>
                <input type="hidden" name="attr_tough_mod" value="0">
            </div>
            <div class="sub_sector">
                Charyzma:<input class="input_short" type="text" name="attr_charisma" value="0" readonly><br>

                Tempo:<input class="input_short" type="text" name="attr_speed" value="6" readonly><br>
            </div>
            <div class="sub_sector">
                Fuksy:<input type="number" name="attr_luck" value="3"><br>
                <input type="hidden" name="attr_luck_max" value="3">

                Rozmiar:<input class="input_short" type="text" name="attr_size" value="0" readonly><br>
            </div>
        </div>

        <!--Przewagi-->
        <div id="Advances" class="sector">
            <h3>Przewagi</h3>
            <div class="sub_sector">
                <div>
                    <fieldset class="repeating_advantage">
                        Nazwa<input type="text" name="attr_advname"><br>
                        Wymagania<input type="text" name="attr_advreq"><br>
                        <details>
                            Opis<br><textarea class="extending_desc" name="attr_advdiscDetails"></textarea>
                        </details>
                    </fieldset>
                </div>
            </div>
        </div>

        <!--Zawady-->
        <div id="Edges" class="sector">
            <h3>Zawady</h3>
            <div class="sub_sector">
                <div>
                    <fieldset class="repeating_edges">
                        Nazwa<input type="text" name="attr_edgname"><br>
                        Stopień<input type="text" name="attr_edgstr"><br>
                        <details>
                            Opis<br><textarea name="attr_edgDetails"></textarea>
                        </details>
                    </fieldset>
                </div>
            </div>
        </div>
    </div><!--Trzecia kolumna--><div class='sheet-col'>
        <div id="resource" class="sector">
            <h3>Zasoby:</h3>
            <div class="sub_sector">
                Punkty światła<input type="number" name="attr_light_point" min="0" max="10" value="0" /><br>
            </div>
            <h4>Amunicja</h4>
            <div class="sub_sector">
                <p style="color:#aeaeae;" id="amno_k"><b>Kinetyczna</b></p><input type="number" name="attr_kinetic_amno"
                    min="0" max="10" value="0" /><br>
            </div>
            <div class="sub_sector">
                <p style="color:#3bff4f;" id="amno_s"><b>Specjalna</b></p><input type="number" name="attr_special_amno"
                    min="0" max="10" value="0" /><br>
            </div>
            <div class="sub_sector">
                <p style="color:#b300ff;" id="amno_h"><b>Ciężka</b></p><input type="number" name="attr_heavy_amno"
                    min="0" max="5" value="0" /><br>
            </div>
        </div>
    </div>
</div>

<div class="sheet-equipment">
    <div class="sector">
        <h3>Ekwipunek</h3>
        <textarea class="big_textfield" name="attr_general_eq"></textarea>
    </div>

    <div class="sector">
        <h3>Waluty</h3>
        <div class="sub_sector">
            Migot <input class="long_number" type="number" name="attr_glimmer" min="0" max="100000000"><br>
        </div>
        <div class="sub_sector">
            Legendarne odłamki <input class="short_number" type="number" name="attr_legendary_shards" min="0" max="100"><br>
        </div>
        <div class="sub_sector">
            Dziwne monety <input class="short_number" type="number" name="attr_strange_coins" min="0" max="100">
        </div>
    </div>

    <div class="sector">
        <div class="card">
            <select class="text_select" name="attr_type" value="-">
                <option value="">-</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select><br>
            <input class="hidden_input" type="text" name="attr_param1"><br>
            <input class="hidden_input" type="text" name="attr_param2"><br>
            <input class="hidden_input" type="text" name="attr_param3"><br>
            <input class="hidden_input" type="text" name="attr_param4"><br>
            <input class="hidden_input" type="text" name="attr_param5"><br>
            <input class="hidden_input" type="text" name="attr_param6"><br>
            <input class="hidden_input" type="text" name="attr_param7"><br>
        </div>
    </div>
</div>

<div class="sheet-details">
    <div class="sector">
        <h3>Opis postaci</h3>
        <div class="sub_sector">
            Opis<textarea id="tx_desc" name="attr_description"></textarea>
        </div>
        <div class="sub_sector">
            Historia<textarea id="tx_hist" name="attr_history"></textarea>
        </div>
        <div class="sub_sector">
            Dlaczego zostałeś wskrzeszony?<textarea id="tx_res" name="attr_resurection"></textarea>
        </div>
    </div>

    <div class="sector" id="sec_two_part">
        <div class="sector" id="sec_notes">
            <div class="sub_sector">
                <h3>Notatki</h3>
                <textarea id="tx_nt" name="attr_notes"></textarea>
            </div>
        </div>
        <div class="sector" id="sec_ghost">
            <h3>Duch</h3>
            <div class="sub_sector">
                Imię<input type="text" name="attr_ghost_name">
            </div>
            <div class="sub_sector">
                Opis<textarea id="tx_gd" name="attr_ghost_desc"></textarea>
            </div>
            <div class="sub_sector">
                Charakter<input type="text" name="attr_ghost_nature1">
            </div>
            <div class="center_sub_sector">
                <input type="text" name="attr_ghost_nature2">
            </div>
            <div class="sub_sector">
                Rany<input class="short_input" type="text" name="attr_ghost_wounds">
            </div>
            <div class="sub_sector">
                Wytrzymałość<input class="short_input" type="text" name="attr_ghost_tough">
            </div>
            <div class="sub_sector">
                Baza danych<select class="short_select" name="attr_data_base" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_data_base_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_data_base"></button><br>
            </div>
            <div class="sub_sector">
                Łączność<select class="short_select" name="attr_connection" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_connection_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_connection"></button><br>
            </div>
            <div class="sub_sector">
                Skanowanie<select class="short_select" name="attr_scan" value="d4">
                    <option value="d4">k4</option>
                    <option value="d6">k6</option>
                    <option value="d8">k8</option>
                    <option value="d10">k10</option>
                    <option value="d12">k12</option>
                </select>
                <input type="hidden" name="attr_scan_mod" value="0">
                <button type="action" class="roll_button" name="act_roll_scan"></button><br>
            </div>
            <input type="hidden" name="attr_ghost_figure" value="0">
        </div>
    </div>
    <input type="number" name="attr_EXP">
    <input type="text" name="attr_DEBUG">
    <input type="text" name="attr_DEBUG2">
    <input type="text" name="attr_DEBUG3">
</div>

<rolltemplate class="sheet-rolltemplate-BasicDiceRoll">
    <div class="sheet-template-container">
        <div class="sheet-template-header">{{name}}</div>
        <div class="sheet-results">
            <div class="sheet-template-row">
                <span>Kość główna = {{wynik}}</span>
            </div>
            <div class="sheet-template-row">
                <span>Kość figury = {{pomoc}}</span>
            </div>
            {{#rollGreater() computed::wynik 3}}
            <div class="sheet-template-row-won">
                <span>Test zdany</span>
            </div>
            {{/rollGreater() computed::wynik 3}}
            {{#rollLess() computed::wynik 4}}
            <div class="sheet-template-row-lost">
                <span>Test niezdany</span>
            </div>
            {{/rollLess() computed::wynik 4}}
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-NoFigureDiceRoll">
    <div class="sheet-template-container">
        <div class="sheet-template-header">{{name}}</div>
        <div class="sheet-results">
            <div class="sheet-template-row">
                <span>Kość główna = {{wynik}}</span>
            </div>
            {{#rollGreater() computed::wynik 3}}
            <div class="sheet-template-row-won">
                <span>Test zdany</span>
            </div>
            {{/rollGreater() computed::wynik 3}}
            {{#rollLess() computed::wynik 4}}
            <div class="sheet-template-row-lost">
                <span>Test niezdany</span>
            </div>
            {{/rollLess() computed::wynik 4}}
        </div>
    </div>
</rolltemplate>


<script type="text/worker">
    //Przełączanie się między stronami
    const buttonlist = ["main","equipment","details"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });

    //Walidacja podklasy
    on("change:subclass", function(){
        getAttrs(["class","subclass"], function(values){
            var cl=values.class;    
            var sc=values.subclass;
            if(cl == "Tytan"){
                if(sc!="Słoneczny pogromca" && sc!="Szturmowiec" && sc!="Wartownik"){
                    setAttrs({subclass: "-"});
                }
            }else if(cl =="Łowca"){
                if(sc!="Strzelec" && sc!="Gromodzierżca" && sc!="Tropiciel"){
                    setAttrs({subclass: "-"});
                }
            }else if(cl == "Czarownik"){
                if(sc!="Ostrze świtu" && sc!="Kroczący przez próżnię" && sc!="Siewca burz"){
                    setAttrs({subclass: "-"});
                }
            }
        })
    })

    //Zmiana liczby doświadczenia
    on("change:EXP", function(){
        getAttrs(["EXP","level"], function(values){
            var e=values.EXP;
            //Pierw ile expa brakuje, dalej jaki level
            setAttrs({
                EXP_To_Next_Level:e%5,
                level: parseInt(e/5)
            });
            var l=values.level;
            if(l<9){
                setAttrs({rank: "Nowicjusz"});
            }else if(l<17){
                setAttrs({rank: "Doświadczony"});
            }else if(l<25){
                setAttrs({rank: "Weteran"});
            }else if(l<33){
                setAttrs({rank: "Heros"});
            }else{
                setAttrs({rank: "Legenda"});
            }
        })
    })

    //Usuwa przedrostek z nazwy kości
    function dice_max_value(dice){
        var v=dice.slice(1)
        return v!=""?v:0
    }

    //Sprawdzanie czy rasa Przebudzonych ma odpowiednią wartość ducha
    on("change:spirit change:race",function(){
        getAttrs(["spirit","race"],function(values){
            var r=values.race
            var s=values.spirit
        
            if(r=="Przebudzony" && s=="d4"){
                setAttrs({spirit: "d6"})
            }
        })
    })

    //Sprawdzanie czy aktualna wartość fuksów nie jest za duża
    on("change:luck",function(){
        getAttrs(["luck_max","luck"],function(values){
            var lm=values.luck_max
            var l=values.luck
            if(l<0){
                setAttrs({luck: 0}) 
            }else if(l>lm){
                setAttrs({luck: lm}) 
            }
        })
    })

    //Obliczanie wytrzymałości
    on("change:vigor change:tough_mod", function(){
        getAttrs(["vigor","tough_mod","size"], function(values){
            var v=parseInt(dice_max_value(values.vigor))    //Parsowanie
            var tm=parseInt(values.tough_mod)
            var s=parseInt(values.size)

            v=v/2+tm+s+2                                    //Dodanie modyfikatorów
            setAttrs({tough: v})                            //ustawienie wytrzymałości
        })
    })

    //Obliczanie obrony
    on("change:brawl change:parry_mod", function(){
        getAttrs(["brawl","parry_mod"], function(values){
            var p=parseInt(dice_max_value(values.brawl))    //Parsowanie
            var pm=parseInt(values.parry_mod)

            p=p/2+pm+2                                      //Dodanie modyfikatorów
            setAttrs({parry: p})                            //ustawienie wytrzymałości
        })
    })

    //Funkcja służąca do podpinania rzutu do przycisku
    function bind_roll(attribute_name,attribute){
        var query="&{template:BasicDiceRoll} "                                                          //Szablon rzutu
        query=query.concat("{{name=@{name} wykonuje test "+attribute_name+"}} ")                        //Nazwa rzutu

        getAttrs([attribute], function(values){
            var atr=values[attribute]
            //Sprawdzenie czy umiejętność jest wykupiona
            if(atr!="-"){
                query=query.concat("{{wynik=[[@{"+attribute+"}! +@{"+attribute+"_mod} +?{Modyfikator|0}]]}} ")    //Rzut kością główną
                query=query.concat("{{pomoc=[[d6! +@{"+attribute+"_mod} +?{Modyfikator|0}]]}}")                   //Rzut kością figury
            }else{
                query=query.concat("{{wynik=[[d4!-2 +@{"+attribute+"_mod} +?{Modyfikator|0}]]}}")             //Rzut kością główną
                query=query.concat("{{pomoc=[[d6!-2 +@{"+attribute+"_mod} +?{Modyfikator|0}]]}}")             //Rzut kością figury
            }

            startRoll(query, (results) => {
                var basicDice = results.results.wynik.result    //Kość główna
                var figDice = results.results.pomoc.result      //Kość figury
                var resDice                                     //Kość wyniku

                //Jeśli kość główna nie jest równa jeden i figury jest większa, to zamień
                if(basicDice>1 && figDice>basicDice){
                    resDice=figDice
                }else{
                    resDice=basicDice
                }
                finishRoll(
                    results.rollId,
                    {
                        wynik: resDice
                    }
                )

            })
        })
    }

    //Funkcja służąca do podpinania rzutu do przycisku dla dodanych umiejętności
    function bind_roll_new(attribute_name,attribute){
        attribute_name="repeating_newskill_"+attribute_name         //Nazwa umiejętności
        attribute="repeating_newskill_"+attribute                   //Wartość umiejętności
        attribute_mod=attribute+"mod"                               //Modyfikator umiejętności
        var query="&{template:BasicDiceRoll} "                      //Szablon rzutu

        getAttrs([attribute,attribute_name,attribute_mod], function(values){
            let name=values[attribute_name]             //Nazwa umiejętności
            let atr=values[attribute]                   //Wartość umiejętności
            let mod=values[attribute_mod]               //Modyfikator umiejętności
            query=query.concat("{{name=@{name} wykonuje test "+name+"}} ")                        //Nazwa rzutu
            //Sprawdzenie czy umiejętność jest wykupiona
            if(atr!="-"){             
                query=query.concat("{{wynik=[["+atr+"! +"+mod+" +?{Modyfikator|0}]]}}")          //Rzut kością główną
                query=query.concat("{{pomoc=[[d6! +"+mod+" +?{Modyfikator|0}]]}}")               //Rzut kością figury
            }else{
                query=query.concat("{{wynik=[[d4!-2 +"+mod+" +?{Modyfikator|0}]]}}")             //Rzut kością główną
                query=query.concat("{{pomoc=[[d6!-2 +"+mod+" +?{Modyfikator|0}]]}}")             //Rzut kością figury
            }
    
            startRoll(query, (results) => {
                var basicDice = results.results.wynik.result    //Kość główna
                var figDice = results.results.pomoc.result      //Kość figury
                var resDice                                     //Kość wyniku
    
                //Jeśli kość główna nie jest równa jeden i figury jest większa, to zamień
                if(basicDice>1 && figDice>basicDice){
                    resDice=figDice
                }else{
                    resDice=basicDice
                }
                finishRoll(
                    results.rollId,
                    {
                        wynik: resDice
                    }
                )
    
            })
        })
    }

        //Funkcja służąca do podpinania rzutu dla umiejętności ducha
        function bind_roll_ghost(attribute_name,attribute){
            getAttrs([attribute,"ghost_figure"], function(values){
                if(!values.ghost_figure){
                    bind_roll(attribute_name,attribute)                         //Jeśli figura, to potraktuj jak umiejętnośc gracza
                    return
                }
                var query="&{template:NoFigureDiceRoll} "                                                      //Szablon rzutu
                query=query.concat("{{name=@{name} wykonuje test "+attribute_name+"}} ")                        //Nazwa rzutu
    
                var atr=values[attribute]

                query=query.concat("{{wynik=[[@{"+attribute+"}! +@{"+attribute+"_mod} +?{Modyfikator|0}]]}} ")    //Rzut kością główną

                startRoll(query, (results) => {
                    var basicDice = results.results.wynik.result    //Kość główna
                    
                    finishRoll(
                        results.rollId,
                        {
                            wynik: basicDice
                        }
                    )
    
                })

            })
        }

    //Przypisanie rzutów do cech
    on('clicked:roll_strength', (info) => {
        bind_roll("siły","strength")
    })

    on('clicked:roll_agility', (info) => {
        bind_roll("zręczności","agility")
    })

    on('clicked:roll_smart', (info) => {
        bind_roll("sprytu","smart")
    })

    on('clicked:roll_spirit', (info) => {
        bind_roll("ducha","spirit")
    })

    on('clicked:roll_vigor', (info) => {
        bind_roll("wigoru","vigor")
    })

    //Przypisanie rzutów do umiejętności
    on('clicked:roll_gamble', (info) => {
        bind_roll("hazardu","gamble")
    })

    on('clicked:roll_survival', (info) => {
        bind_roll("przetrwania","survival")
    })
    
    on('clicked:roll_repair', (info) => {
        bind_roll("reperowania","repair")
    })

    on('clicked:roll_spot', (info) => {
        bind_roll("spostrzegawczości","spot")
    })

    on('clicked:roll_tracking', (info) => {
        bind_roll("tropienia","tracking")
    })

    on('clicked:roll_search', (info) => {
        bind_roll("wyszukiwania","search")
    })

    on('clicked:roll_ridicule', (info) => {
        bind_roll("wyśmiewania","ridicule")
    })

    on('clicked:roll_pilotage', (info) => {
        bind_roll("pilotowania","pilotage")
    })

    on('clicked:roll_drive', (info) => {
        bind_roll("prowadzenia","drive")
    })

    on('clicked:roll_move', (info) => {
        bind_roll("ruchu","move")
    })

    on('clicked:roll_throw', (info) => {
        bind_roll("rzucania","throw")
    })

    on('clicked:roll_stealth', (info) => {
        bind_roll("skradania się","stealth")
    })

    on('clicked:roll_shoot', (info) => {
        bind_roll("strzelania","shoot")
    })

    on('clicked:roll_brawl', (info) => {
        bind_roll("walki wręcz","brawl")
    })

    on('clicked:roll_breaking', (info) => {
        bind_roll("włamywania się","breaking")
    })

    on('clicked:roll_persuade', (info) => {
        bind_roll("przekonywania","persuade")
    })

    on('clicked:roll_intimidate', (info) => {
        bind_roll("zastraszania","intimidate")
    })

    on('clicked:repeating_newskill:rollns', (info) => {
        bind_roll_new("nsname","nsvalue")
    })

    //Umiejętności ducha
    on('clicked:roll_data_base', (info) => {
        bind_roll_ghost("bazy danych","data_base")
    })

    on('clicked:roll_connection', (info) => {
        bind_roll_ghost("łączności","connection")
    })

    on('clicked:roll_scan', (info) => {
        bind_roll_ghost("skanowania","scan")
    })

    //Test
    on("change:type", function(){
        getAttrs(["type"], function(values){
            var t=values.type
            setAttrs({
                param1: t,
                param2: t,
                param3: t,
                param4: t,
                param5: t,
                param6: t,
                param7: t
            })
        })
    })
     
</script>